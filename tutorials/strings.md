# Строки

## Символьные данные

В язык FreeBASIC существуют три вида символьных типов данных: `ZString`, `WString` и `String`.

ZString
 ~ Тип данных, содержащий 8‐битные символы, ANSI‐строки

WString
 ~ Тип данных, содержащий широкий (юникодный) символ, Wide‐строки

String
 ~ Аналогичен `ZString`, но с динамически изменяемой длиной строки

Рассмотрим, как устроены символьные данные в памяти.

### ZString

`ZString` для представления символов используется принцип «Pointer to Character String Zero-terminated» (PSZ) — указатель на символьные данные, завершённые нулём. При таком расположении в памяти в конце строки находится нуль-символ (символ с кодом 0), по которому мы можем определить конец строки. Длина строки PSZ ограничена лишь объёмом свободной памяти.

Например, в строковом *буфере* (области памяти, выделенной для хранения строки) размером 16 байт нуль-терминированная строка «СТРОКА» в кодировке Windows-1251 представляется следующим образом:

::::: {.memorydump}

|   Адрес  | 00 | 01 | 02 | 03 | 04 | 05 | 06     | 07 | Символы  |
|----------|----|----|----|----|----|----|--------|----|----------|
| 0065FE00 | D1 | D2 | D0 | CE | CA | C0 | **00** | BA | СТРОКА є |
| 0065FE08 | 0D | F0 | AD | BA | 0D | F0 | AD     | BA | ♪р-є♪р-є |

:::::

В данном примере представлена область памяти из 16 байт:

* байты с 00 по 05 — символьные данные;
* байт 06 — нулевой символ;
* байты после нуль-символа (07 — 0F байты) называются *мусором* — это данные, которые остались в буфере от предыдущих строк или от других использований памяти, среди них также могут встречаться нулевые символы.

Сама строка занимает 7 символов, но длина строки — 6 символов, потому что нулевой символ не входит в символьные данные, нулевой символ показывает где строка заканчивается.


### WString

Для хранения символов юникода необходимо больше байт, из-за чего их называют широкими символами (Wide Characters). Здесь используется принцип «Pointer to Wide-character String Zero-terminated» (PWSZ) — указатель на символьные данные, завершённые нулём:

::::: {.memorydump}

|   Адрес  | 00 | 01 | 02 | 03 | 04     | 05     | 06 | 07 | Символы |
|----------|----|----|----|----|--------|--------|----|----|---------|
| 0065FE00 | 21 | 04 | 22 | 04 | 20     | 04     | 1E | 04 | С Т Р О |
| 0065FE08 | 1A | 04 | 10 | 04 | **00** | **00** | AD | BA | К А   몭 |

:::::

Для широких строк используется кодировка UTF-16, поэтому каждый символ теперь занимает два байта. В широкой строке нулевой символ тоже широкий, поэтому он занимает два байта.

* байты с 00 по 0B — символьные данные;
* байты 0C-OD — нулевой символ;
* байты 0E-0F — мусор.

Не следует путать длину строки и количество байт памяти, которые она занимает. Длина строки осталась равна 6 символам, а количество байт — 12. Символ не равен байту.

### Тип данных String

Тип данных для строк, доставшийся в наследство от QuickBasic. Является удобной объектной оболочкой для `ZString` с автоматическим управлением памятью. Представляет из себя структуру из указателя на символьные данные, длины строки и ёмкости:

```FreeBASIC
Type String
	data As ZString Ptr
	len As Integer
	size As Integer
End Type
```

Использование такой реализации имеет ряд преимуществ:

* длину строки не нужно пересчитывать — она хранится в заголовке;
* null-символ становится законным символом в строке, а не только признаком конца строки.


